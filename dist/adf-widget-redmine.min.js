!function(e,t){"use strict";angular.module("adf.widget.redmine",["adf.provider","smart-table","chart.js","ui.bootstrap.datepicker"]).constant("redmineEndpoint","http://www.redmine.org/").config(["dashboardProvider",function(e){var t={templateUrl:"{widgetsPath}/redmine/src/issues/edit/edit.html",controller:"editController",controllerAs:"vm",resolve:{projects:["redmineService",function(e){return e.getProjects()}]}},o={templateUrl:"{widgetsPath}/redmine/src/chart/edit/edit.html",controller:"editController",controllerAs:"vm",resolve:{projects:["redmineService",function(e){return e.getProjects()}]}};e.widget("redmine-issues",{title:"Redmine Issues",description:"Shows Issues of a given Redmine Instance",templateUrl:"{widgetsPath}/redmine/src/issues/view.html",controller:"IssueController",controllerAs:"vm",resolve:{issues:["redmineService","config",function(e,t){return e.getIssues(t)}]},edit:t}),e.widget("redmine-chart",{title:"Redmine Chart",description:"Displays a burnup or burndown chart",templateUrl:"{widgetsPath}/redmine/src/chart/view.html",controller:"ChartController",controllerAs:"vm",resolve:{issues:["redmineService","config",function(e,t){return e.getIssues(t)}]},edit:o})}]),angular.module("adf.widget.redmine").run(["$templateCache",function(e){e.put("{widgetsPath}/redmine/src/chart/view.html",'<div class="alert alert-info" ng-if=!vm.chart>Please configure the widget</div><div ng-if=vm.chart><canvas id=line class="chart chart-line" chart-data=vm.chart.data chart-labels=vm.chart.labels chart-series=vm.chart.series chart-options=vm.chart.options></canvas></div>'),e.put("{widgetsPath}/redmine/src/issues/view.html",'<table st-table=rowCollection class="table table-striped"><thead><tr><th ng-if=vm.config.columns.id.show>ID</th><th ng-if=vm.config.columns.tracker.show>Tracker</th><th ng-if=vm.config.columns.status.show>Status</th><th ng-if=vm.config.columns.subject.show>Subject</th></tr></thead><tbody><tr ng-repeat="issue in vm.issues"><td ng-if=vm.config.columns.id.show><a href=\'{{"http://www.redmine.org/issues/"+issue.id}}\'>{{issue.id}}</a></td><td ng-if=vm.config.columns.tracker.show>{{issue.tracker.name}}</td><td ng-if=vm.config.columns.status.show>{{issue.status.name}}</td><td ng-if=vm.config.columns.subject.show>{{issue.subject}}</td></tr></tbody></table>'),e.put("{widgetsPath}/redmine/src/chart/edit/edit.html",'<form role=form><div class=form-group><label for=project>Project</label><select name=project id=project class=form-control ng-model=config.project><option value=All>All</option><option ng-repeat="project in vm.projects | orderBy: \'name\'" value={{project.id}}>{{project.name}}</option></select></div><div class=form-group><label for=assgined_to_id>Assigned To</label> <span class="glyphicon glyphicon-info-sign" uib-tooltip="Get issues which are assigned to the given user ID. <me> can be used instead an ID to fetch all issues from the logged in user. Leave empty if you want to see all issues."></span> <input name=assigned_to_id id=assgined_to_id class=form-control ng-model=config.assigned_to_id></div><div><p class=input-group><input class=form-control datepicker-options=vm.dateOptions is-open=vm.popup1.opened ng-model=vm.config.timespan.fromDateTime placeholder=from show-button-bar=false type=text uib-datepicker-popup={{format}}> <span class=input-group-btn><button class="btn btn-default" ng-click=vm.open1() type=button><i class="glyphicon glyphicon-calendar"></i></button></span></p><p class=input-group><input class=form-control datepicker-options=vm.dateOptions is-open=vm.popup2.opened ng-model=vm.config.timespan.toDateTime placeholder=to show-button-bar=false type=text uib-datepicker-popup={{format}}> <span class=input-group-btn><button class="btn btn-default" ng-click=vm.open2() type=button><i class="glyphicon glyphicon-calendar"></i></button></span></p></div></form>'),e.put("{widgetsPath}/redmine/src/issues/edit/edit.html",'<form role=form><div class=form-group><label for=project>Project</label><select name=project id=project class=form-control ng-model=config.project><option value=All>All</option><option ng-repeat="project in vm.projects | orderBy: \'name\'" value={{project.id}}>{{project.name}}</option></select></div><div class=form-group><label for=assgined_to_id>Assigned To</label> <span class="glyphicon glyphicon-info-sign" uib-tooltip="Get issues which are assigned to the given user ID. <me> can be used instead an ID to fetch all issues from the logged in user. Leave empty if you want to see all issues."></span> <input name=assigned_to_id id=assgined_to_id class=form-control ng-model=config.assigned_to_id></div><div class=form-group><input type=checkbox name=showClosed ng-model=config.showClosed> Show closed issues</div><div class=form-group><label for=project>Columns to show:</label><li class=list-group-item ng-repeat="(key, entry) in vm.possibleColumns"><input type=checkbox name={{key}} ng-model=config.columns[key].show> {{entry.name}}</li></div></form>')}]),angular.module("adf.widget.redmine").controller("editController",["projects","config",function(e,t){var o=this;o.possibleColumns={id:{name:"ID",show:!0},tracker:{name:"Tracker",show:!0},status:{name:"Status",show:!0},subject:{name:"Subject",show:!0}},angular.equals({},t)&&(t.columns=o.possibleColumns,t.project="",t.assigned_to_id="me",t.showClosed=!1),o.projects=e}]),angular.module("adf.widget.redmine").controller("editController",["projects","config",function(e,t){function o(e){var t=e.date,o=e.mode;if("day"===o)for(var s=new Date(t).setHours(0,0,0,0),i=0;i<n.events.length;i++){var r=new Date(n.events[i].date).setHours(0,0,0,0);if(s===r)return n.events[i].status}return""}var n=this;n.config=t,angular.equals({},t)&&(t.project="",t.assigned_to_id="me",t.showClosed=!0),n.config.timespan||(n.config.timespan={}),n.config.timespan.fromDateTime&&(n.config.timespan.fromDateTime=new Date(n.config.timespan.fromDateTime),n.config.timespan.toDateTime=new Date(n.config.timespan.toDateTime)),n.projects=e,n.inlineOptions={customClass:o,minDate:new Date,showWeeks:!0},n.dateOptions||(n.dateOptions={formatYear:"yy",startingDay:1}),n.toggleMin=function(){n.inlineOptions.minDate=n.inlineOptions.minDate?null:new Date,n.dateOptions.minDate=n.inlineOptions.minDate},n.toggleMin(),n.open1=function(){n.popup1.opened=!0},n.open2=function(){n.popup2.opened=!0},n.formats=["yyyy-MM-dd","yyyy/MM/dd","dd.MM.yyyy","shortDate"],n.format=n.formats[0],n.altInputFormats=["M!/d!/yyyy"],n.popup1={opened:!1},n.popup2={opened:!1}}]),angular.module("adf.widget.redmine").controller("IssueController",["issues","config",function(e,t){var o=this;o.config=t,o.issues=e.issues}]),angular.module("adf.widget.redmine").controller("ChartController",["issues","config",function(e,t){var o=this;o.config=t,o.issues=e;var n=function(e,t,o){for(var n=[],r=[],a=[];e.getTime()<=t.getTime();)s(o,n,e),i(n,e),r.push(e.toDateString()),a.push(n.length),e.setDate(e.getDate()+1);return{dates:r,values:a}},s=function(e,t,o){for(var n=0;n<e.length;n++){var s=new Date(e[n].created_on);s.getTime()<=o.getTime()&&(t.push(e[n]),e.splice(n,1),n--)}},i=function(e,t){for(var o=0;o<e.length;o++)if(e[o].closed_on){var n=new Date(e[o].closed_on);n.getTime()<=t.getTime()&&(e.splice(o,1),o--)}},r=new Date(o.config.timespan.fromDateTime),a=new Date(o.config.timespan.toDateTime),l=n(r,a,e),c={scales:{yAxes:[{id:"y-axis-1",display:!0,position:"left",scaleLabel:{display:!0,labelString:"Open Issues"}}]},legend:{display:!0,position:"bottom"}};o.chart={labels:l.dates,data:[l.values],series:["Project ..."],"class":"chart-line",options:c}}]),angular.module("adf.widget.redmine").factory("redmineService",["$http","redmineEndpoint",function(e,t){function o(e){return e.data}function n(n){return e.get(t+n).then(o)}function s(e){var t=[],o=r(e),n=e.limit?e.limit:Number.MAX_SAFE_INTEGER;return i(o,t,0,n)}function i(e,t,o,s){return n("issues.json"+e+"&offset="+o).then(function(n){return angular.forEach(n.issues,function(e){t.push(e)}),n.total_count>t.length&&t.length<s?i(e,t,o+100,s):t})}function r(e){var t="?limit=100";if(e.project&&"All"!==e.project&&(t+="&project_id="+e.project),e.assigned_to_id&&(t+="&assigned_to_id="+e.assigned_to_id),e.showClosed&&(t+="&status_id=*"),e.timespan.fromDateTime&&e.timespan.toDateTime){var o=new Date(e.timespan.fromDateTime),n=new Date(e.timespan.toDateTime);t+="&created_on=%3E%3C"+a(o)+"|"+a(n)}return t}function a(e){var t=e.getDate(),o=e.getMonth()+1,n=e.getFullYear();return""+n+"-"+(o<=9?"0"+o:o)+"-"+(t<=9?"0"+t:t)}function l(){return n("projects.json").then(function(e){return e.projects})}return{getIssues:s,getProjects:l}}])}(window);