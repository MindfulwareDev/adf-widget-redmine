!function(e,t){"use strict";angular.module("adf.widget.redmine",["adf.provider","smart-table","chart.js","ui.bootstrap.datepicker"]).constant("redmineEndpoint","http://www.redmine.org/").config(["dashboardProvider",function(e){var t={templateUrl:"{widgetsPath}/redmine/src/main/issues/edit/edit.html",controller:"editIssuesController",controllerAs:"vm",resolve:{projects:["redmineService",function(e){return e.getProjects()}]}},n={templateUrl:"{widgetsPath}/redmine/src/main/chart/edit/edit.html",controller:"editChartController",controllerAs:"vm",resolve:{projects:["redmineService",function(e){return e.getProjects()}]}};e.widget("redmine-issues",{title:"Redmine Issues",description:"Shows Issues of a given Redmine Instance",templateUrl:"{widgetsPath}/redmine/src/main/issues/view.html",controller:"IssueController",controllerAs:"vm",resolve:{issues:["redmineService","config",function(e,t){return e.getIssues(t)}]},edit:t}),e.widget("redmine-chart",{title:"Redmine Chart",description:"Displays a burnup or burndown chart",templateUrl:"{widgetsPath}/redmine/src/main/chart/view.html",controller:"ChartController",controllerAs:"vm",resolve:{issues:["redmineService","config",function(e,t){if(t.project)return e.getIssues(t)}]},edit:n})}]),angular.module("adf.widget.redmine").run(["$templateCache",function(e){e.put("{widgetsPath}/redmine/src/chart/view.html",'<div class="alert alert-info" ng-if=!vm.chart>Please configure the widget</div><div ng-if=vm.chart><canvas id=line class="chart chart-line" chart-data=vm.chart.data chart-labels=vm.chart.labels chart-series=vm.chart.series chart-options=vm.chart.options></canvas></div>'),e.put("{widgetsPath}/redmine/src/issues/view.html",'<div class="alert alert-info" ng-if=!vm.config.columns>Please configure the widget</div><div ng-if=vm.config.columns><table st-table=rowCollection class="table table-striped"><thead><tr><th ng-if=vm.config.columns.id.show>ID</th><th ng-if=vm.config.columns.tracker.show>Tracker</th><th ng-if=vm.config.columns.status.show>Status</th><th ng-if=vm.config.columns.subject.show>Subject</th></tr></thead><tbody><tr ng-repeat="issue in vm.issues"><td ng-if=vm.config.columns.id.show><a href=http://www.redmine.org/issues/{{issue.id}}>{{issue.id}}</a></td><td ng-if=vm.config.columns.tracker.show>{{issue.tracker.name}}</td><td ng-if=vm.config.columns.status.show>{{issue.status.name}}</td><td ng-if=vm.config.columns.subject.show>{{issue.subject}}</td></tr></tbody></table></div>'),e.put("{widgetsPath}/redmine/src/chart/edit/edit.html",'<form role=form><div class=form-group><label for=project>Filter</label></div><div class=form-group><label for=project>Project</label><select name=project id=project class=form-control ng-model=vm.config.project ng-change=vm.checkUpdates()><option value=All>All</option><option ng-repeat="project in vm.projects | orderBy: \'name\'" value={{project}}>{{project.name}}</option></select></div><p class=input-group>Add Filter<select name=filter id=filter class=form-control ng-model=vm.filterToAdd ng-change=vm.addFilter(vm.filterToAdd)><option ng-repeat="filter in vm.filters | orderBy: \'name\'" value={{filter.id}}>{{filter.name}}</option></select></p><div class=form-group ng-if=vm.config.filterWithVersion ng-init=vm.updateVersions() "><label for=version>Fixed Version</label><select name=version id=version class=form-control ng-model=vm.config.version ng-change=vm.updateVersionEnd()><option ng-repeat="version in vm.versions | orderBy: \'name\'" value={{version}}>{{version.name}}</option></select></div><div class=form-group><label for=assgined_to_id>Assigned To</label> <span class="glyphicon glyphicon-info-sign" uib-tooltip="Get issues which are assigned to the given user ID. <me> can be used instead an ID to fetch all issues from the logged in user. Leave empty if you want to see all issues."></span> <input name=assigned_to_id id=assgined_to_id class=form-control ng-model=config.assigned_to_id></div><div class=form-group><input type=checkbox name=showIdeal ng-model=config.showIdeal> Show ideal line</div><div><p class=input-group><input class=form-control datepicker-options=vm.dateOptions is-open=vm.popup1.opened ng-model=vm.config.timespan.fromDateTime placeholder=from show-button-bar=false type=text uib-datepicker-popup={{format}}> <span class=input-group-btn><button class="btn btn-default" ng-click=vm.open1() type=button><i class="glyphicon glyphicon-calendar"></i></button></span></p><p class=input-group><input class=form-control datepicker-options=vm.dateOptions is-open=vm.popup2.opened ng-model=vm.config.timespan.toDateTime placeholder=to show-button-bar=false type=text uib-datepicker-popup={{format}}> <span class=input-group-btn><button class="btn btn-default" ng-click=vm.open2() type=button><i class="glyphicon glyphicon-calendar"></i></button></span></p></div></form>'),e.put("{widgetsPath}/redmine/src/issues/edit/edit.html",'<form role=form><div class=form-group><label for=project>Project</label><select name=project id=project class=form-control ng-model=config.project><option value=All>All</option><option ng-repeat="project in vm.projects | orderBy: \'name\'" value={{project.id}}>{{project.name}}</option></select></div><div class=form-group><label for=assgined_to_id>Assigned To</label> <span class="glyphicon glyphicon-info-sign" uib-tooltip="Get issues which are assigned to the given user ID. <me> can be used instead an ID to fetch all issues from the logged in user. Leave empty if you want to see all issues."></span> <input name=assigned_to_id id=assgined_to_id class=form-control ng-model=config.assigned_to_id></div><div class=form-group><input type=checkbox name=showClosed ng-model=config.showClosed> Show closed issues</div><div class=form-group><label for=project>Columns to show:</label><li class=list-group-item ng-repeat="(key, entry) in vm.possibleColumns"><input type=checkbox name={{key}} ng-model=config.columns[key].show> {{entry.name}}</li></div></form>')}]),angular.module("adf.widget.redmine").controller("editIssuesController",["projects","config",function(e,t){var n=this;console.log("config: "+t),n.possibleColumns={id:{name:"ID",show:!0},tracker:{name:"Tracker",show:!0},status:{name:"Status",show:!0},subject:{name:"Subject",show:!0}},angular.equals({},t)&&(t.columns=n.possibleColumns,t.project="",t.assigned_to_id="me",t.showClosed=!1),n.projects=e}]),angular.module("adf.widget.redmine").controller("editChartController",["projects","config","redmineService",function(e,t,n){function o(e){var t=e.date,n=e.mode;if("day"===n)for(var o=new Date(t).setHours(0,0,0,0),s=0;s<i.events.length;s++){var r=new Date(i.events[s].date).setHours(0,0,0,0);if(o===r)return i.events[s].status}return""}var i=this;i.config=t,i.filters=[{id:"version",name:"Fixed Version"}],angular.equals({},t)&&(i.config.project="",i.config.showClosed=!0),i.addFilter=function(e){"version"===e&&(i.config.filterWithVersion=!0),i.filterToAdd="none"},i.config.timespan||(i.config.timespan={}),i.config.timespan.fromDateTime&&(i.config.timespan.fromDateTime=new Date(i.config.timespan.fromDateTime),i.config.timespan.toDateTime=new Date(i.config.timespan.toDateTime)),i.projects=e,i.inlineOptions={customClass:o,minDate:new Date,showWeeks:!0},i.dateOptions||(i.dateOptions={formatYear:"yy",startingDay:1}),i.toggleMin=function(){i.inlineOptions.minDate=i.inlineOptions.minDate?null:new Date,i.dateOptions.minDate=i.inlineOptions.minDate},i.toggleMin(),i.open1=function(){i.popup1.opened=!0},i.open2=function(){i.popup2.opened=!0},i.formats=["yyyy-MM-dd","yyyy/MM/dd","dd.MM.yyyy","shortDate"],i.format=i.formats[0],i.altInputFormats=["M!/d!/yyyy"],i.popup1={opened:!1},i.popup2={opened:!1},i.updateVersions=function(){if(i.config.project){if("All"===i.config.project)return void(i.versions=[]);n.getVersions(angular.fromJson(i.config.project).identifier).then(function(e){console.log(e),i.versions=e})}},i.checkUpdates=function(){i.config.filterWithVersion&&i.updateVersions()},i.updateVersionEnd=function(){i.config.timespan.toDateTime=new Date(angular.fromJson(i.config.version).due_date);var e=new Date(i.config.timespan.toDateTime);i.config.timespan.fromDateTime=e.setDate(e.getDate()-14)}}]),angular.module("adf.widget.redmine").controller("IssueController",["issues","config",function(e,t){var n=this;n.config=t,n.config.limit||(n.config.limit=25),n.issues=e}]),angular.module("adf.widget.redmine").controller("ChartController",["issues","config",function(e,t){var n=this;n.config=t,n.issues=e,n.numberAllIssues=e.length;var o=function(e,t,o){for(var r=Math.abs(e.getTime()-t.getTime()),a=Math.ceil(r/864e5),l=n.numberAllIssues/a,c=[],d=[],m=[],u=[];e.getTime()<=t.getTime();){i(o,d,e),s(d,e),m.push(e.toDateString());var p=d.length;if(u.push(p),n.config.showIdeal){var f=n.numberAllIssues-c.length*l;console.log(f),c.push(f)}e.setDate(e.getDate()+1)}var g=[u];return n.config.showIdeal&&g.push(c),{dates:m,values:g}},i=function(e,t,n){for(var o=0;o<e.length;o++){var i=new Date(e[o].created_on);if(!(i.getTime()<=n.getTime()))break;t.push(e[o]),e.splice(o,1),o--}},s=function(e,t){for(var n=0;n<e.length;n++)if(e[n].closed_on){var o=new Date(e[n].closed_on);o.getTime()<=t.getTime()&&(e.splice(n,1),n--)}};if(n.config.timespan&&n.config.timespan.fromDateTime&&n.config.timespan.toDateTime){var r=new Date(n.config.timespan.fromDateTime),a=new Date(n.config.timespan.toDateTime),l=o(r,a,e),c={scales:{yAxes:[{id:"y-axis-1",display:!0,position:"left",scaleLabel:{display:!0,labelString:"Open Issues"}}]},legend:{display:!0,position:"bottom"}};n.chart={labels:l.dates,data:l.values,series:["Project ..."],"class":"chart-line",options:c},n.config.showIdeal&&n.chart.series.push("Ideal")}}]),angular.module("adf.widget.redmine").factory("redmineService",["$http","redmineEndpoint","$q",function(e,t,n){function o(e){return e.data}function i(n){return e.get(t+n).then(o)}function s(){return i("projects.json").then(function(e){return e.projects})}function r(e){return i("projects/"+e+"/versions.json").then(function(e){return e.versions})}function a(e){var t=[],o=c(e),i=e.limit?e.limit:Number.MAX_SAFE_INTEGER;return l(o,0).then(function(e){angular.forEach(e.issues,function(e){t.push(e)});for(var s=[],r=100;r<e.total_count&&r<i;r+=100)s.push(l(o,r));return o.length>0?n.all(s).then(function(e){return angular.forEach(e,function(e){angular.forEach(e.issues,function(e){t.push(e)})}),t}):t})}function l(e,t){return i("issues.json"+e+"&offset="+t).then(function(e){return e})}function c(e){var t="?limit=100&sort=created_on";if(e.project&&"All"!==e.project&&(t+="&project_id="+angular.fromJson(e.project).id),e.assigned_to_id&&(t+="&assigned_to_id="+e.assigned_to_id),e.showClosed&&(t+="&status_id=*"),e.timespan&&e.timespan.fromDateTime&&e.timespan.toDateTime){var n=(new Date(e.timespan.fromDateTime),new Date(e.timespan.toDateTime));t+="&created_on=<="+d(n)}return e.filterWithVersion&&e.version&&(t+="&fixed_version_id="+angular.fromJson(e.version).id),t}function d(e){var t=e.getDate(),n=e.getMonth()+1,o=e.getFullYear();return""+o+"-"+(n<=9?"0"+n:n)+"-"+(t<=9?"0"+t:t)}return{getIssues:a,getProjects:s,getVersions:r}}])}(window);